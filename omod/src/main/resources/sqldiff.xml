<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
	<help>
		USE:
			The diffs are ordered by datamodel version number.
			The script can be run in a top down fashion and is
			expected to not failor overwrite old data
		
		EXPECT:
			- "use business-database-name;" was called prior to
			   calling this script
	</help>
	
	<diff>
		<version>1.0.0</version>
		<author>Ben Wolfe</author>
		<date>Dec 27th 2006</date>
		<description>
			Adding formEntry queue/archive tables
		</description>
		<sql>
			CREATE TABLE IF NOT EXISTS `formentry_archive` (
			  `formentry_archive_id` int(11) NOT NULL auto_increment,
			  `form_data` mediumtext NOT NULL,
			  `date_created` datetime NOT NULL default '0000-00-00 00:00:00',
			  `creator` int(11) NOT NULL default '0',
			  PRIMARY KEY  (`formentry_archive_id`),
			  KEY `User who created formentry_archive` (`creator`),
			  CONSTRAINT `User who created formentry_archive` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `formentry_error` (
			  `formentry_error_id` int(11) NOT NULL auto_increment,
			  `form_data` mediumtext NOT NULL,
			  `error` varchar(255) NOT NULL default '',
			  `error_details` text,
			  `creator` int(11) NOT NULL default '0',
			  `date_created` datetime NOT NULL default '0000-00-00 00:00:00',
			  PRIMARY KEY  (`formentry_error_id`),
			  KEY `User who created formentry_error` (`creator`),
			  CONSTRAINT `User who created formentry_error` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `formentry_queue` (
			  `formentry_queue_id` int(11) NOT NULL auto_increment,
			  `form_data` mediumtext NOT NULL,
			  `status` int(11) NOT NULL default '0' COMMENT '0=pending, 1=processing, 2=processed, 3=error',
			  `date_processed` datetime default NULL,
			  `error_msg` varchar(255) default NULL,
			  `creator` int(11) NOT NULL default '0',
			  `date_created` datetime NOT NULL default '0000-00-00 00:00:00',
			  PRIMARY KEY  (`formentry_queue_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
		</sql>
	</diff>
	
	
	<diff>
		<version>1.0.1</version>
		<author>Ben Wolfe</author>
		<date>Dec 27th 2006</date>
		<description>
			Modifying global properties and formentry processor task class for scheduler 
			
			The "DELETE FROM" line is unfortunate.  I can't come up with a way to do the 
			second update line 'only if' formEntry.patientForms.goBackOnEntry doesn't exist
		</description>
		<sql>
			DELETE FROM
				global_property
			WHERE
				property = 'formentry.patientForms.goBackOnEntry';
			
			
			UPDATE 
				global_property
			SET
				property = 'formEntry.patientForms.goBackOnEntry'
			WHERE
				property = 'patientForms.goBackOnEntry';
								
			
			UPDATE
				scheduler_task_config
			SET
				schedulable_class = 'org.openmrs.module.formEntry.ProcessFormEntryQueueTask'
			WHERE
				schedulable_class = 'org.openmrs.scheduler.tasks.ProcessFormEntryQueueTask';
			
		</sql>
	</diff>
	
	
	<diff>
		<version>1.1.0</version>
		<author>Ben Wolfe</author>
		<date>Jan 3rd 2007</date>
		<description>
			Changing all formentry.* global properties to formEntry.*
		</description>
		<sql>
			UPDATE 
				global_property
			SET
				property = REPLACE(property, 'formentry.', 'formEntry.')
			WHERE
				INSTR(property, 'formentry') = 1;
			
		</sql>
	</diff>
	
	
	<diff>
		<version>1.3.0</version>
		<author>Ben Wolfe</author>
		<date>Jan 10th 2006</date>
		<description>
			Modifying formentry processor for the new package name
		</description>
		<sql>
			UPDATE
				scheduler_task_config
			SET
				schedulable_class = 'org.openmrs.module.formentry.ProcessFormEntryQueueTask'
			WHERE
				schedulable_class = 'org.openmrs.module.formEntry.ProcessFormEntryQueueTask';
			
		</sql>
	</diff>

	<diff>
		<version>1.8</version>
		<author>Burke Mamlin</author>
		<date>Feb 19th 2007</date>
		<description>
			Changing all formEntry.* global properties back to formentry.*
			Must delete the auto generated by id properties first, otherwise
			we get an exception when renaming
		</description>
		<sql>
			
			DELETE FROM
				global_property
			WHERE
				property in ('formEntry.started', 'formEntry.database_version');
				
			
			UPDATE 
				global_property
			SET
				property = REPLACE(property, 'formEntry.', 'formentry.')
			WHERE
				INSTR(property, 'formEntry') = 1;
			
		</sql>
	</diff>

</sqldiff>
